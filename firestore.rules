rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Sessions utilisateur
    match /users/{uid}/sessions/{sid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Prix communautaires
    match /publicPrices/{docId} {
      allow read: if true;

      function isAuthed() { return request.auth != null; }

      function validServer() {
        return docId.matches('^(Brial|Dakal|Draconiros|Hell Mina|Imagiro|Kourial|Mikhal|Orukam|Rafal|Salar|Shadow|Tal Kasha|Tylezia)_(ing|sell)_[0-9]+$');
      }

      function isValidHistEntry(e) {
        return e is map && e.t is timestamp && e.p is number && e.p >= 0;
      }

      function isValidPriceDoc() {
        return request.resource.data.kind in ['ing','sell']
          && request.resource.data.itemId is int
          && request.resource.data.lastPrice is number && request.resource.data.lastPrice >= 0
          && (request.resource.data.lastAt == null || request.resource.data.lastAt is timestamp)
          && (request.resource.data.lastUserId == null || request.resource.data.lastUserId is string)
          && request.resource.data.history is list
          && request.resource.data.history.size() <= 50
          && (request.resource.data.history.size() == 0
              || isValidHistEntry(request.resource.data.history[request.resource.data.history.size() - 1]));
      }

      allow create, update: if isAuthed() && validServer() && isValidPriceDoc();
      allow delete: if false;
    }

    // Favoris utilisateur
    match /userFavorites/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid
        && request.resource.data.keys().hasAll(['uid', 'itemId', 'addedAt'])
        && request.resource.data.uid is string
        && request.resource.data.itemId is int
        && request.resource.data.addedAt is timestamp;
      // Permettre la lecture de tous les documents pour le filtrage côté client
      allow read: if request.auth != null;
    }

    // Noms d'utilisateur (règles temporaires pour développement)
    match /userNames/{uid} {
      allow read, write: if true; // Temporaire pour le développement
    }

    // Index des noms d'utilisateur (règles temporaires pour développement)
    match /usernameIndex/{username} {
      allow read, write: if true; // Temporaire pour le développement
    }

    // Profils utilisateurs (pour les photos de profil dans le leaderboard)
    match /userProfiles/{uid} {
      allow read: if true; // Lecture publique pour le leaderboard
      allow write: if request.auth != null && request.auth.uid == uid
        && request.resource.data.keys().hasAll(['uid', 'email', 'displayName', 'photoURL', 'lastSeen', 'createdAt'])
        && request.resource.data.uid is string
        && request.resource.data.email is string
        && (request.resource.data.displayName == null || request.resource.data.displayName is string)
        && (request.resource.data.photoURL == null || request.resource.data.photoURL is string)
        && request.resource.data.lastSeen is timestamp
        && request.resource.data.createdAt is timestamp;
    }
  }
}
